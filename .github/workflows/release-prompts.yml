name: Auto-version Prompts

on:
  push:
    branches: [main]
    paths:
      - "rules-kit/**"

permissions:
  contents: write

jobs:
  version-and-tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate CalVer version
        id: version
        run: |
          DATE=$(date -u +"%Y.%m.%d")
          # Получаем теги напрямую из удаленного репозитория и фильтруем по паттерну
          REMOTE_TAGS=$(git ls-remote --tags origin | grep "refs/tags/prompts/v${DATE}\." | sed "s/.*refs\/tags\/prompts\/v${DATE}\.//" | sed "s/\^{}//" | sort -n)

          if [ -z "$REMOTE_TAGS" ]; then
              # Если тегов нет, начинаем с 01
              INCREMENT="01"
          else
              # Находим максимальный инкремент и увеличиваем на 1 с лидирующим нулем
              MAX_INCREMENT=$(echo "$REMOTE_TAGS" | tail -n 1)
              INCREMENT=$((MAX_INCREMENT + 1))
              # Добавляем лидирующий ноль если число < 10
              if [ $INCREMENT -lt 10 ]; then
                  INCREMENT="0${INCREMENT}"
              fi
          fi

          VERSION="${DATE}.${INCREMENT}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

      - name: Create Git Tag
        run: |
          git tag prompts/v${{ steps.version.outputs.version }}
          git push origin prompts/v${{ steps.version.outputs.version }}
