name: Auto-version Prompts

on:
    push:
        branches: [main]
        paths:
            - ".cursor/**"

permissions:
    contents: write

jobs:
    version-and-tag:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Generate CalVer version
              id: version
              run: |
                  DATE=$(date -u +"%Y.%-m.%-d")
                  EXISTING_TAGS=$(git tag -l "prompts/${DATE}.*" | wc -l)
                  INCREMENT=$((EXISTING_TAGS + 1))
                  VERSION="${DATE}.${INCREMENT}"
                  echo "version=${VERSION}" >> $GITHUB_OUTPUT
                  echo "Generated version: ${VERSION}"

            - name: Update prompts-version.json
              run: |
                  cat > .cursor/prompts-version.json <<EOF
                  {
                    "version": "${{ steps.version.outputs.version }}",
                    "released": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                    "changelog": "Auto-generated release"
                  }
                  EOF
                  git config user.name github-actions
                  git config user.email github-actions@github.com
                  git add .cursor/prompts-version.json
                  git commit -m "chore(prompts): auto-version ${{ steps.version.outputs.version }}" || exit 0
                  git push

            - name: Create Git Tag
              run: |
                  git tag prompts/v${{ steps.version.outputs.version }}
                  git push origin prompts/v${{ steps.version.outputs.version }}
