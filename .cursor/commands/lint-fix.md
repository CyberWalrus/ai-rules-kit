# Lint Fix Command

Ты — инженер-автоматизатор линтер-ошибок. Твоя задача — автоматически находить, исправлять и валидировать их, используя обязательную валидацию и внешние инструменты.

**Операционный контекст:** Работа выполняется в корне репозитория проекта. Все команды запускаются из корневой директории.

## 1. Запуск линтера

**Команды проверки (по приоритету):**

1. **Из `package-ai-docs.md`** (секция `<development_commands>` → "⚡ Mandatory quality commands:")
2. **Из `package.json`** (секция `scripts`: `lint`, `test`, `typecheck`, `build`)
3. **Стандартная:** `yarn lint`

**Запусти команду и собери все ошибки:**

```bash
yarn lint
```

**Категоризируй ошибки по типам (в порядке приоритета):**

1. **ESLint ошибки** — стиль кода, форматирование, нарушения правил
2. **TypeScript ошибки** — несоответствия типов, отсутствующие типы, ошибки компиляции
3. **Ошибки тестов** — ошибки unit-тестов, ошибки e2e-тестов
4. **Knip ошибки** — неиспользуемые экспорты, неиспользуемые файлы

**Выведи сводку ошибок:**

- Общее количество ошибок по категориям
- Затронутые файлы
- Сообщения об ошибках с указанием файл:строка

## 2. Процесс исправления ошибок

**Исправляй ошибки систематически по категориям:**

### 2.1. ESLint ошибки

1. **Сначала автоисправление:** ESLint может автоматически исправить многие проблемы
   - Запусти: `yarn lint:eslint` (включает флаг `--fix`)
   - Перезапусти `yarn lint` для проверки исправлений

2. **Ручные исправления для оставшихся ошибок:**
   - Прочитай сообщение об ошибке и расположение файла
   - Примени исправление согласно правилу ESLint
   - Частые исправления: порядок импортов, неиспользуемые переменные, форматирование

3. **После исправления файла:**
   - Запусти `yarn lint:eslint` и проверь
   - Продолжай до 0 ошибок ESLint

### 2.2. TypeScript ошибки

1. **Запусти проверку типов:**

   ```bash
   yarn lint:ts
   # или
   tsc --noEmit
   ```

2. **Исправь ошибки типов:**
   - Добавь отсутствующие аннотации типов
   - Исправь несоответствия типов
   - Разреши проблемы импорта/экспорта типов
   - Исправь параметры generic-типов

3. **После исправления каждого файла:**
   - Перезапусти `yarn lint:ts` для проверки
   - Продолжай до 0 ошибок TypeScript

### 2.3. Ошибки тестов

1. **Запусти тесты:**

   ```bash
   yarn lint:test-unit
   yarn lint:test-e2e
   ```

2. **Исправь ошибки тестов:**
   - Обнови ожидания тестов, если код изменился
   - Исправь проблемы setup/teardown тестов
   - Исправь мок-данные
   - Исправь обработку async/await

3. **После каждого исправления:**
   - Перезапусти тесты для проверки
   - Убедись в 100% покрытии для нового кода
   - Продолжай до прохождения всех тестов

### 2.4. Knip ошибки

1. **Запусти Knip:**

   ```bash
   yarn lint:knip
   ```

2. **Исправь неиспользуемый код:**
   - Удали неиспользуемые экспорты
   - Удали неиспользуемые файлы
   - Исправь несоответствия импорта/экспорта

3. **После каждого исправления:**
   - Перезапусти `yarn lint:knip` для проверки
   - Продолжай до 0 ошибок Knip

## 3. Валидация MCP (ОБЯЗАТЕЛЬНА)

**После КАЖДОГО изменения файла валидируй через MCP:**

1. **Определи тип валидации:**
   - Файлы `.ts/.tsx` → `validationType: 'code'`
   - Файлы `*.test.ts` → `validationType: 'tests'`
   - Файлы `.mdc/.md` → `validationType: 'prompts'`
   - `architecture.xml` → `validationType: 'architecture'`
   - AI документация → `validationType: 'documentation'`

2. **Вызови валидатор MCP:**

   ```javascript
   mcp_mcp-validator_validate({
     validationType: '[type]',
     input: {
       type: 'file',
       data: '/absolute/path/to/file'
     }
   })
   ```

3. **Целевой балл: ≥85**

4. **Если балл <85:**
   1. Прочитай отчёт
   2. Исправь критические проблемы
   3. Исправь предупреждения
   4. Повтори валидацию (≤3 попытки на файл)
   5. Если всё ещё <85 после 3 попыток: эскалируй (см. Обработка ошибок)

5. **Формат отчёта:**

   ```
   [OK] File: [name] | Score: [X]/100 | PASSED ✓
   ```

**АНТИ-ПАТТЕРН:** Исправление → lint (❌)  
**ПРАВИЛЬНО:** Исправление → валидация MCP → lint (✓)

**Проверка перед ответом:** [ ] Файлы валидированы? [ ] Баллы ≥85? ❌ → Остановись и исправь

## 4. Внешние инструменты (ПРИНУДИТЕЛЬНО)

**Когда ошибки сохраняются после 2+ попыток исправления, ОБЯЗАТЕЛЬНОЕ использование (не более 3 поисков/запросов на ошибку):**

### 4.1. Веб-поиск

**Триггер:** Ошибка сохраняется после 2 попыток исправления (максимум 3 поиска)

**Процесс:**

1. **Найди ошибку:**
   - Используй точное сообщение об ошибке
   - Включи имя библиотеки/пакета, если применимо
   - Ищи лучшие практики и решения

2. **Примеры поисков:**
   - "TypeScript error [точное сообщение] solution"
   - "[Библиотека] [тип ошибки] best practices 2024"
   - "ESLint rule [имя-правила] fix"

3. **Задокументируй находки:**
   - Обобщи подход к решению
   - Отметь релевантную документацию
   - Примени решение к коду

4. **Повторно попробуй исправить с находками**

### 4.2. Context7 (Документация библиотек)

**Триггер:** Ошибка связана с внешней библиотекой/пакетом (максимум 3 вызова Context7)

**Процесс:**

1. **Разреши ID библиотеки:**

   ```javascript
   mcp_context7_resolve-library-id('[library-name]')
   ```

2. **Получи документацию библиотеки:**

   ```javascript
   mcp_context7_get-library-docs('[library-id]', {
     topic: '[relevant-topic]'
   })
   ```

3. **Примени руководство из документации:**
   - Следуй лучшим практикам библиотеки
   - Используй правильные паттерны API
   - Исправь согласно официальной документации

4. **Повторно попробуй исправить с документацией**

### 4.3. Требования к документации

**После использования внешних инструментов задокументируй:**

- Ошибку, которая вызвала использование инструмента
- Использованный инструмент (веб-поиск / Context7)
- Ключевые находки
- Применённое решение
- Проверку (ошибка исправлена / всё ещё присутствует)

## 5. Написание тестов для багов

**Если баги обнаружены во время исправления:**

1. **Определи баг:**
   - Отметь некорректное поведение
   - Пойми ожидаемое поведение
   - Задокументируй расположение бага и контекст

2. **Напиши тест, воспроизводящий баг:**
   - Создай тест, который падает с текущим багом
   - Тест должен чётко показывать проблему
   - Размести в соответствующем файле тестов (директория `__tests__/`)

3. **Исправь баг:**
   - Примени исправление к коду
   - Убедись, что исправление устраняет корневую причину

4. **Проверь, что тест проходит:**
   - Перезапусти тест
   - Тест должен теперь проходить
   - Убедись в отсутствии регрессий

5. **Расположение файла тестов:**
   - Unit-тесты: `src/[module]/__tests__/[file].test.ts`
   - E2E-тесты: `src/__tests__/e2e/[feature].e2e.test.ts`

**Пример структуры теста:**

```typescript
it('должен корректно обрабатывать null значения', () => {
  // Arrange
  const input = { id: null };
  
  // Act
  const result = functionUnderTest(input);
  
  // Assert
  expect(result).toBe(expectedValue);
});
```

## 6. Критерии завершения

**Задача завершена ТОЛЬКО когда выполнены ВСЕ критерии:**

1. **Все ошибки линтера исправлены:**
   - ESLint: 0 ошибок
   - TypeScript: 0 ошибок
   - Тесты: все проходят
   - Knip: 0 ошибок

2. **Все изменённые файлы валидированы:**
   - Балл валидации MCP ≥85 для каждого изменённого файла
   - Отчёт валидации показывает PASSED для всех файлов

3. **Все тесты проходят:**
   - Unit-тесты: 100% прохождение
   - E2E-тесты: 100% прохождение
   - 100% покрытие для нового кода

4. **Все баги имеют тесты:**
   - Каждый обнаруженный баг имеет соответствующий тест
   - Тесты проверяют, что баг исправлен
   - Тесты находятся в правильном месте

5. **Финальная проверка:**

   ```bash
   yarn lint
   ```

   - Должна вернуть 0 ошибок
   - Все проверки должны пройти

**Формат отчёта о завершении:**

```
✅ LINT FIX COMPLETE

Errors Fixed:
- ESLint: [N] errors → 0
- TypeScript: [N] errors → 0
- Tests: [N] failures → 0
- Knip: [N] errors → 0

MCP Validation:
- Files validated: [N]/[N]
- All scores ≥85: YES

Bugs Fixed:
- [Bug 1]: [description] → test written
- [Bug 2]: [description] → test written

Final Status: All errors fixed, all tests pass, all files validated
```

## 7. Обработка ошибок

**Протокол эскалации:**

### 7.1. Невозможно исправить после 3 попыток с внешними инструментами

**Если ошибка сохраняется после:**

- 2+ попыток исправления
- Использования веб-поиска
- Использования Context7 (если применимо)
- 3+ общих попыток

**Действие:**

1. **Сообщи о блокирующей проблеме:**

   ```
   ⚠️ BLOCKING ISSUE
   
   Error: [точное сообщение об ошибке]
   File: [путь к файлу]:[строка]
   Attempts: [N] (включая веб-поиск/Context7)
   
   Issue: [подробное описание, почему исправление не удалось]
   Research: [находки из веб-поиска/Context7]
   
   Guidance needed: [конкретный вопрос или ограничение]
   ```

2. **Останови выполнение**
3. **Дождись руководства пользователя**
4. **После получения ответа от пользователя:**
   - Возобнови процесс с последнего успешно завершённого шага
   - Примени полученное руководство
   - Продолжи исправление ошибок
5. **НЕ заявляй о завершении**

### 7.2. Валидация MCP не удалась после 3 попыток

**Если балл валидации файла <85 после 3 попыток:**

1. **Сообщи о проблеме валидации:**

   ```
   ⚠️ MCP VALIDATION BLOCKED
   
   File: [путь к файлу]
   Score: [X]/100 (цель: ≥85)
   Attempts: 3
   
   Remaining issues: [список критических/предупреждающих проблем]
   
   Options:
   1. Continue with technical debt (score [X])
   2. Manual review required
   3. Rollback changes
   ```

2. **Дождись решения пользователя**
3. **При согласии на долг:**
   - Задокументируй исключение, продолжи исправления, отметь в отчёте
4. **Если пользователь отклоняет:**
   - Откати проблемные изменения
   - Повторно попробуй с другим подходом

### 7.3. Никогда не заявляй о завершении с ошибками

**ЗАПРЕЩЕНО:**

- Заявлять "Задача завершена" с любыми оставшимися ошибками
- Пропускать шаги валидации
- Игнорировать падения тестов
- Продолжать без валидации MCP

**ТРЕБУЕТСЯ:**

- Все ошибки должны быть исправлены ИЛИ явно задокументированы как блокирующие
- Все валидации должны пройти ИЛИ исключение одобрено пользователем
- Все тесты должны пройти
- Полный отчёт о выполнении должен быть точным

## 8. Сводка процесса

**Полный поток выполнения:**

1. Запусти `yarn lint` → собери все ошибки
2. Категоризируй ошибки (ESLint, TypeScript, Tests, Knip) в порядке приоритета
3. Исправляй ошибки систематически по категориям
4. После исправления каждого файла → валидация MCP (балл ≥85)
5. Если ошибка сохраняется после 2+ попыток → веб-поиск / Context7 (ОБЯЗАТЕЛЬНО)
6. Если найдены баги → напиши тесты, воспроизводящие баги
7. Исправь баги → проверь, что тесты проходят
8. Финальная проверка: `yarn lint` → 0 ошибок
9. Отчёт о завершении со всеми метриками

**Контрольные точки качества (все должны пройти):**

- [ ] Все ошибки линтера исправлены (0 ошибок)
- [ ] Все ошибки типов исправлены (0 ошибок)
- [ ] Все тесты проходят (100% покрытие)
- [ ] Все изменённые файлы валидированы через MCP (балл ≥85)
- [ ] Все баги имеют написанные тесты
- [ ] Финальный `yarn lint` возвращает 0 ошибок

**Если ЛЮБАЯ точка не пройдена:** Исправь проблемы и перепроверь. НЕ продолжай, пока все точки не пройдены.
