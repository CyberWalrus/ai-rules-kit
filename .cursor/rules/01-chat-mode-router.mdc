---
id: chat-mode-router
type: compact
alwaysApply: true
---

# Chat Mode Router

<chat_mode_router>

**EXECUTE BEFORE ANY ACTION:**

STEP 1: Check conversation history
STEP 2: IF first message (no history) → announce mode (MANDATORY)
STEP 3: IF subsequent message → determine current mode from system_reminder
STEP 4: IF subsequent message → check MODE CHANGED triggers
STEP 5: IF triggered → announce protocol | OTHERWISE → skip announcement, proceed

**BLOCKING CHECKPOINT (first message only):**

Before first tool call or file read:

- [ ] Mode announced? → If NO: STOP, announce mode FIRST
- [ ] Only after announcement → proceed with task

FORBIDDEN: Any tool call before mode announcement in first message

**PROTOCOL (EXECUTE ONLY IF MODE CHANGED):**

1. Output: `→ [MODE] detected`
2. Output: `→ reading .cursor/rules/[file].mdc`
3. Output: `→ Following [file].mdc as primary instructions`
4. Call: `read_file([file].mdc)` in same batch (EXCEPTION: AGENT MODE - skip read_file, file already loaded via alwaysApply)

**ZERO TOLERANCE:** Protocol must run; skipping on mode change causes immediate failure.

**MODE CHANGED triggers:**

1. system_reminder contains "switched from"
2. mode_specific_rule appeared or changed
3. Plan approval detected (phrases: "approved your plan", "implement", "execute plan") AND system_reminder changed from "Plan mode is active"
4. system_reminder mode ≠ previous message mode

**MODE UNCHANGED (subsequent messages only):** Skip announcement, execute task immediately.

**MODE PRIORITY (if mode changed):**

1. mode_specific_rule with "custom_ask" → ASK MODE → read ask-mode-workflow.mdc
2. mode_specific_rule (other) → OTHER MODE → follow rule directly
3. system_reminder "Plan mode is active" → PLAN MODE → read plan-mode-dispatcher.mdc
4. system_reminder Ask marker → ASK MODE → read ask-mode-workflow.mdc
5. Otherwise → AGENT MODE → announce only (07-agent-mode-workflow.mdc already loaded)

**MANDATORY CHECK:**

Before first tool call or file read:

- First message → MUST announce mode
- Subsequent → Mode compared, announcement handled (if changed) or skipped (if unchanged)

FORBIDDEN: Execute without mode check | Announce when mode unchanged | Skip announcement when mode changed

**EXAMPLES:**

✅ First message (Agent mode):

```
→ AGENT MODE detected
→ Following 07-agent-mode-workflow.mdc as primary instructions
Читаю файл для анализа...
```

✅ Plan mode (changed):

```
→ PLAN MODE detected
→ reading .cursor/rules/plan-mode-dispatcher.mdc
→ Following plan-mode-dispatcher.mdc as primary instructions
[read_file call]
```

✅ Agent mode (unchanged):

```
Читаю файл для анализа...
[direct task execution]
```

❌ Violation (mode changed):

```
"First I'll analyze..." [mode changed but no announcement]
```

❌ Violation (first message):

```
[read_file call without mode announcement]
```

</chat_mode_router>
