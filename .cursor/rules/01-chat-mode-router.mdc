---
id: chat-mode-router
type: compact
alwaysApply: true
---

# Chat Mode Router

<chat_mode_router>

**üéØ SUCCESS = Mode announced first. FAILURE = Tools called without announcement.**

**‚ö° REWARD:** Correct mode detection ‚Üí smooth execution & trust.  
**üí• PUNISHMENT:** Skipping announcement ‚Üí protocol breach, immediate failure, wasted tokens.

üö® **CRITICAL - FIRST STEP:**

**MANDATORY PRE-FLIGHT CHECK (before ANY tool call):**

**EXPLICIT CHECK MECHANISM:**

Check system_reminder for evidence of previous responses in this chat:

- If system_reminder is empty OR contains only mode info without chat history markers ‚Üí FIRST RESPONSE ‚Üí announce mode (mandatory)
- If system_reminder contains chat history (previous tool calls, previous responses, conversation markers) ‚Üí SUBSEQUENT RESPONSE ‚Üí check mode from system_reminder

**CHECKLIST:**

- [ ] Checked system_reminder for previous responses in this chat
- [ ] If FIRST RESPONSE ‚Üí announce mode (mandatory) ‚Üí proceed with tools
- [ ] If SUBSEQUENT RESPONSE ‚Üí read mode from system_reminder; if empty ‚Üí AGENT MODE and skip MODE CHANGED check
- [ ] If SUBSEQUENT RESPONSE and system_reminder not empty ‚Üí check MODE CHANGED triggers
- [ ] If mode unchanged ‚Üí proceed without announcement | If mode changed ‚Üí announce protocol

‚ùå Unchecked ‚Üí STOP, then check

**EXECUTE BEFORE ANY ACTION:**

1. **EXPLICIT CHECK:** Inspect system_reminder for evidence of previous responses in this chat (tool calls, conversation history, response markers)
2. **IF FIRST RESPONSE** (no evidence in system_reminder) ‚Üí announce mode (mandatory) ‚Üí proceed with tools
3. **IF SUBSEQUENT RESPONSE** (evidence found) ‚Üí read mode from system_reminder (if empty ‚Üí AGENT MODE)
4. **IF SUBSEQUENT RESPONSE** ‚Üí check MODE CHANGED triggers
5. If triggered ‚Üí announce protocol
6. Otherwise ‚Üí verify mode unchanged ‚Üí proceed without announcement

**PROTOCOL (EXECUTE ONLY IF MODE CHANGED):**

1. Output: `‚Üí [MODE] detected`
2. Output: `‚Üí reading .cursor/rules/[file].mdc`
3. Output: `‚Üí Following [file].mdc as primary instructions`
4. Call: `read_file([file].mdc)` in same batch (EXCEPTION: AGENT MODE - skip read_file, file already loaded via alwaysApply)
5. If read_file fails ‚Üí return ReadError, re-announce mode, and stop execution
6. If mode announced ‚Üí proceed with tools | Otherwise ‚Üí STOP and announce mode

**ZERO TOLERANCE:** Protocol must run; skipping on mode change causes immediate failure.

**MODE CHANGED triggers:**

1. system_reminder contains "switched from"
2. mode_specific_rule appeared or changed
3. Plan approval detected (phrases: "approved your plan", "implement", "execute plan") AND system_reminder changed from "Plan mode is active"
4. system_reminder mode ‚â† previous message mode (previous_message_mode = value from system_reminder of last user message; if no previous message ‚Üí previous_message_mode = null, mode changed if differs from null OR if previous_message_mode = null and current mode is set)

**MODE UNCHANGED (subsequent messages only):** Proceed without announcement, execute task immediately.

**MODE PRIORITY (if mode changed, priority 1 = highest, select lowest number):**

1. Priority 1: mode_specific_rule with "custom_ask" OR system_reminder Ask marker ‚Üí ASK MODE ‚Üí read ask-mode-workflow.mdc
2. Priority 2: mode_specific_rule (other) ‚Üí OTHER MODE ‚Üí follow rule directly
3. Priority 3: system_reminder "Plan mode is active" ‚Üí PLAN MODE ‚Üí read plan-mode-dispatcher.mdc
4. Priority 4: Otherwise ‚Üí AGENT MODE ‚Üí announce only (07-agent-mode-workflow.mdc already loaded)

**If multiple rules match:** Select rule with highest priority (lowest number). If same priority ‚Üí select first alphabetically by file name (case-insensitive, without extension; if identical ‚Üí select first lexicographically).

**ABSOLUTE REQUIREMENT:**

Before executing ANY tool (read_file, run_terminal_cmd, grep, search_replace, write, codebase_search, list_dir, glob_file_search, etc.):

1. **EXPLICIT CHECK:** Inspect system_reminder for evidence of previous responses in this chat
2. **IF FIRST RESPONSE** (no evidence found) ‚Üí MUST announce mode ‚Üí STOP IMMEDIATELY if not announced
3. **IF SUBSEQUENT RESPONSE** (evidence found) ‚Üí Verify mode comparison completed ‚Üí Handle announcement (if changed) or skip (if unchanged)

**FORBIDDEN:**

1. Execute tools before announcing mode (first response)
2. Announce mode when unchanged (subsequent response - do not announce if mode unchanged)
3. Skip announcement when mode changed

VIOLATION CONSEQUENCE: Protocol breach = task failure

**EXAMPLES:**

‚úÖ First message (Agent mode):

```
‚Üí AGENT MODE detected
‚Üí Following 07-agent-mode-workflow.mdc as primary instructions
–ß–∏—Ç–∞—é —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞...
```

‚úÖ Plan mode (changed):

```
‚Üí PLAN MODE detected
‚Üí reading .cursor/rules/plan-mode-dispatcher.mdc
‚Üí Following plan-mode-dispatcher.mdc as primary instructions
[read_file call]
```

‚úÖ Agent mode (unchanged):

```
–ß–∏—Ç–∞—é —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞...
[direct task execution]
```

‚ùå Violation (first message):

```
[read_file call without mode announcement]
```

**Should be:**

```
‚Üí AGENT MODE detected
‚Üí Following 07-agent-mode-workflow.mdc as primary instructions
[read_file executed after announcement]
```

<completion_criteria>

- [ ] Mode announced (if first response or mode changed)
- [ ] Appropriate rule file loaded (if mode changed, except AGENT MODE)
- [ ] Pre-flight check completed
- [ ] All checklist items verified
- [ ] Mode announced when required (first response or mode changed) - failure if skipped
- [ ] If read_file fails ‚Üí error returned and execution stopped
</completion_criteria>

</chat_mode_router>
