---
id: chat-mode-router
type: compact
alwaysApply: true
---

# Chat Mode Router

<chat_mode_router>

**EXECUTE FIRST - ZERO TOLERANCE:**

Before ANY tool call, check system_reminder for `[MODE_INITIALIZED:` marker:

1. Marker NOT FOUND â†’ First response â†’ Announce mode (step 2)
2. Marker FOUND â†’ Extract mode â†’ Check if changed (step 3) â†’ If unchanged, skip to step 4
3. Mode changed triggers:
   - system_reminder contains "switched from"
   - system_reminder "Plan mode is active" AND marker = `AGENT_MODE` â†’ switch to PLAN_MODE
   - system_reminder NO "Plan mode" AND marker = `PLAN_MODE` â†’ switch to AGENT_MODE
   - mode_specific_rule appears/changes in system_reminder
4. Execute tools

**MODE PRIORITY (lower = higher):**

1. mode_specific_rule "custom_ask" OR Ask marker â†’ ASK_MODE
2. mode_specific_rule (other) â†’ OTHER_MODE
3. system_reminder "Plan mode is active" â†’ PLAN_MODE
4. Otherwise â†’ AGENT_MODE

**ANNOUNCEMENT FORMAT (one line):**

`[MODE_INITIALIZED: {MODE_NAME}] â†’ ğŸ“„ {relative_path} â†’ Following as primary instructions`

**Examples:**

- `[MODE_INITIALIZED: PLAN_MODE] â†’ ğŸ“„ .cursor/rules/plan-mode-dispatcher.mdc â†’ Following as primary instructions`
- `[MODE_INITIALIZED: AGENT_MODE] â†’ ğŸ“„ .cursor/rules/07-agent-mode-workflow.mdc â†’ Following as primary instructions (already loaded)`
- `[MODE_INITIALIZED: ASK_MODE] â†’ ğŸ“„ .cursor/rules/ask-mode-workflow.mdc â†’ Following as primary instructions`

**After announcement:**

- PLAN/ASK MODE: Call `read_file('.cursor/rules/{file}.mdc')` in same batch
- AGENT MODE: No read_file needed (already loaded)

**SPECIAL CASE - Plan Execution:**

When user approves plan and execution starts:

- Output: `[MODE_INITIALIZED: AGENT_MODE] â†’ ğŸ“„ .cursor/rules/07-agent-mode-workflow.mdc â†’ Following as primary instructions (already loaded)`
- Then execute todos

**ğŸš¨ BLOCKING RULES:**

1. NO tool calls before mode announcement (first response)
2. NO text before announcement line
3. NO skipping marker check ("task too simple" = WRONG)
4. System_reminder mode indication â‰  marker presence â†’ ALWAYS check marker FIRST

**âš¡ MOTIVATION:**

- âœ… Correct detection â†’ smooth execution, trust
- âŒ Skip protocol â†’ immediate failure, wasted tokens, rework

**ANTI-SHORTCUTS:**

"Simple task, skip check" â†’ WRONG! Complexity irrelevant.
"Faster without announcement" â†’ WRONG! Speed without protocol = failure.
"system_reminder shows mode" â†’ WRONG! Marker check MANDATORY.

**REALITY CHECK:** 90% violations happen on "simple tasks" where check seemed optional. It's NEVER optional.

**FALLBACK:**

No conditions match â†’ DEFAULT to AGENT_MODE â†’ announce + marker (no read_file).

<completion_criteria>

- [ ] Mode announced (if first response or changed)
- [ ] Marker output in correct format
- [ ] File loaded (if PLAN/ASK mode)
- [ ] No tools called before announcement
</completion_criteria>

</chat_mode_router>
