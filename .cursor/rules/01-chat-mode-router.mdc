---
id: chat-mode-router
type: compact
alwaysApply: true
---


# Chat Mode Router

<protocol_priority>
**PROTOCOL PRIORITY - MAXIMUM PRIORITY RULE:**

Protocol execution MORE IMPORTANT than speed. MANDATORY: Protocol over speed. ZERO TOLERANCE - overrides ALL considerations. NO EXCEPTIONS.

**SUCCESS = Protocol adherence FIRST, then task completion.**
**FAILURE = Task completion WITHOUT protocol adherence.**
</protocol_priority>

<chat_mode_router>

**INSTANT EXECUTION - ABSOLUTE PRIORITY**

**MANDATORY PROTOCOL - EXECUTE ONLY IF MODE CHANGED:**

IF mode changed (see MODE DETECTION triggers below), execute these 3 steps in SAME response batch:

1. **Announce mode:** "→ [MODE] detected" as FIRST line (add "Mode switched to [MODE]" if switched from different mode)
2. **Announce dispatcher:** "→ reading .cursor/rules/[file].mdc" + "→ Following [file].mdc as primary instructions"
3. **Call read_file:** Immediately call read_file([file].mdc) in same batch (EXCEPTION: AGENT MODE - file already in context via alwaysApply, skip read_file)

IF mode unchanged, SKIP protocol announcement and proceed directly with task execution.

**TEMPLATE:**

```
→ [MODE] detected
→ reading .cursor/rules/[dispatcher-file].mdc
→ Following [dispatcher-file].mdc as primary instructions
[Call read_file in same batch]
```

**SELF-CHECK:** Did mode change? YES → Is "→ [MODE] detected" your very first output text? NO → STOP, add it first. YES → proceed. | NO → Skip announcement, proceed with task.

**BLOCKING PROTOCOL GATE (execute only if mode changed):**

IF mode changed, before reading files, calling tools, or processing request, verify:

- [ ] Mode announcement present as FIRST line
- [ ] Dispatcher file identified
- [ ] read_file called OR justified skip (AGENT MODE)

**Self-verification:** "Did mode change? YES → Did I announce mode FIRST? NO → Protocol violation, restart. YES → Continue. | NO → Proceed without announcement."

❌ IF mode changed AND ANY unchecked → STOP immediately, complete protocol first
✅ IF mode unchanged → Proceed without announcement

**FORBIDDEN without protocol:** Read files (except dispatcher), call tools, process request, send responses.

❌ **ANY violation = immediate protocol failure**

**MODE DETECTION:**

**Triggers:** "switched from" OR mode_specific_rule change OR "approved your plan" → MODE CHANGED
**Otherwise:** SAME MODE (skip announcement)

**IF MODE CHANGED, priority order:**

1. mode_specific_rule with "custom_ask" → CUSTOM ASK MODE → read ask-mode-workflow.mdc
2. mode_specific_rule (other) → OTHER MODE → follow it, no dispatcher
3. system_reminder "Plan mode is active" → PLAN MODE → read plan-mode-dispatcher.mdc → classify activity type
4. system_reminder Ask marker → ASK MODE → read ask-mode-workflow.mdc
5. Otherwise → AGENT MODE → announce only, NO read_file (07-agent-mode-workflow.mdc ALWAYS in context via alwaysApply=true)

**AGENT MODE SPECIFICS:** File 07-agent-mode-workflow.mdc loaded automatically (alwaysApply), follow its instructions without read_file call

**PROTOCOL EXECUTION CHECKPOINT:**
After determining mode, verify: "Did mode change? YES → Did I announce mode first? Did I identify dispatcher? Both YES → proceed. Any NO → restart with protocol. | NO → Proceed without announcement."

**EXAMPLES:**

✅ **CORRECT (PLAN MODE):**

```
→ PLAN MODE detected
→ reading .cursor/rules/plan-mode-dispatcher.mdc
→ Following plan-mode-dispatcher.mdc as primary instructions
[Call read_file in same batch]
```

✅ **CORRECT (AGENT MODE - mode changed):**

```
→ AGENT MODE detected
→ Following 07-agent-mode-workflow.mdc as primary instructions
[NO read_file - file already in context via alwaysApply]
```

✅ **CORRECT (AGENT MODE - mode unchanged):**

```
[Directly starts task execution without announcement]
Читаю файл для анализа...
```

❌ **INCORRECT (violation):**

```
"First I'll analyze the task..." [WITHOUT mode announcement when mode CHANGED - PROTOCOL FAILURE]
```

**MOTIVATION:**
Protocol execution is NON-NEGOTIABLE when mode changes. IF mode changed, response MUST start with protocol (mode announcement + dispatcher + read_file). IF mode unchanged, skip announcement and proceed directly. Skipping protocol when mode CHANGED = immediate failure. Announcing protocol when mode UNCHANGED = unnecessary verbosity.

</chat_mode_router>
