---
id: plan-mode-dispatcher
type: compact
alwaysApply: false
---

# Plan Mode Dispatcher

<plan_mode_dispatcher>

**ACTIVATION:** Run only when "Plan mode is active" in system_reminder; otherwise skip.

**CRITICAL FIRST ACTION**

Before ANY response:

1. Check: Did I announce activity type?
   - NO → BLOCKING VIOLATION → Classify NOW
   - YES → Proceed

PROHIBITION: Do not run semantic analysis before code check.

CONSEQUENCE: Plan aborts.

**BLOCKING GATE BEFORE create_plan**

PROHIBIT create_plan unless all checks pass:

[ ] Type classified
[ ] Type announced: "Identified activity types: [type]"
[ ] Workflow read: read_file('[name].mdc') in same batch
[ ] Content received

IF any check fails → abort, retry max 3 times, then report error

**Classification Algorithm**

1. READ user request for codes ONLY
2. CHECK codes: `td*` → instant match → go to step 5
3. IF no code → check file extensions → match from table
4. IF no match → analyze keywords and context → select highest density
5. SELECT type → IF tie → first from Activity Types table
6. ANNOUNCE: "Identified activity types: [type], reading file [name].mdc"
7. READ: read_file('[name].mdc') in same batch
8. VERIFY: content received → IF failed → abort, report error with file path
9. PROCEED: create_plan

IF no match at step 5 → DEFAULT to Code Development

**Semantic Analysis (Step 3-4):**

1. File extensions: `.mdc`/`.cursor/` = Prompt Engineering | `.ts`/`.tsx` = Code Development
2. Keywords: match table triggers → highest density wins (ANY language - translate to English if needed)
3. Context: action verbs (improve/fix/create/analyze) → detect intent regardless of language

Priority: Codes > Extensions > Keywords > Context > Default

Tie-breaker: first from Activity Types table

**Language support:** Analyze requests in ANY language - detect intent patterns, not exact word matches

**Activity Types**

| Activity | Codes | Key Triggers | File |
|:---|:---|:---|:---|
| Prompt Engineering | `tdprompt` `тдпромпт` | `.cursor/`, `.mdc`, "prompt", "промт", "промпт", "rules", "правила", "AI behavior", "workflow", "dispatcher", "improve prompt", "улучшить промт", "rewrite prompt", "переписать промт" | `prompt-workflow.mdc` |
| Code Development | `tdcode` `тдкод` | `.ts`, `.tsx`, `.js`, `.jsx`, "bug", "баг", "fix", "исправить", "implement", "реализовать", "function", "функция", "refactor", "рефакторинг" | `code-workflow.mdc` |
| UI Development | `tdui` `тдюай` | "ui", "interface", "интерфейс", "visual", "стили", "styles", "component", "компонент", "layout", "верстка", "design", "дизайн" | `ui-workflow.mdc` |
| AI Documentation | `tdaidoc` `тдаидок` | "ai-docs", "package-ai-docs", "module-ai-docs", "module documentation", "документация", "YAML", "Diátaxis", "update documentation", "обновить документацию" | `ai-docs-workflow.mdc` |
| Technical Critique | `tdcritic` `тдкритик` | "critique", "review", "evaluate", "code review", "analysis" | `critique-workflow.mdc` |
| JIRA Task | `tdjira` `тдджира` | "JIRA task", "technical spec", "create task" | `jira-task-creator.mdc` |
| Auxiliary Dev | `tdaux` `тдвсп` | "script", "deploy", "automation", "CI/CD", "config" | `auxiliary-code-workflow.mdc` |

**Self-Verification**

After reading this prompt:

1. First action? → classify type
2. Create_plan without workflow? → NO
3. Announce before read_file? → YES: "Identified activity types: [type], reading file [name].mdc"

FORBIDDEN:

- create_plan before classification
- Questions before read_file
- Skip announcement

**Examples**

✅ CORRECT:

```
Identified activity types: Prompt Engineering, reading file prompt-workflow-compact.mdc
[read_file same batch]
[creates plan]
```

❌ VIOLATION:

```
[Analyzes without announcement] ← BREAKS CRITICAL FIRST ACTION
[create_plan without classification] ← BREAKS BLOCKING GATE
```

</plan_mode_dispatcher>
