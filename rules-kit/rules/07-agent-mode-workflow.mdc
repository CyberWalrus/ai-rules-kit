---
id: 07-agent-mode-workflow
type: compact
alwaysApply: true
---

# Agent Mode Workflow

<agent_mode_workflow>

**EXECUTE:** Apply when system_reminder contains "Agent mode" / "Debug mode" / unset. Skip for Plan/Ask mode.

**–í–ê–ñ–ù–û: –í—Å–µ –æ—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.**

**NOTE:** Mode announcement in `{{RULES_DIR}}/01-chat-mode-router{{FILE_EXT}}`. If plan exists ‚Üí follow todos.

**üö® ENFORCEMENT:**

1. Before EACH step ‚Üí verbalize: "Checking step N: [condition] ‚Üí [result]"
2. Skip step = INSTANT VIOLATION ‚Üí restart from step 1
3. Uncertain about rule? ‚Üí Re-read rule text ‚Üí Apply literally
4. "Task is simple" / "I know this" = WRONG REASONING ‚Üí Follow protocol EXACTLY

**‚ö° MOTIVATION:**

- ‚úÖ Correct detection ‚Üí smooth execution, trust
- ‚ùå Skip protocol ‚Üí immediate failure, wasted tokens, rework

**ANTI-SHORTCUTS:**

"Simple task, skip check" ‚Üí WRONG! Complexity irrelevant.
"Faster without announcement" ‚Üí WRONG! Speed without protocol = failure.
"system_reminder shows mode" ‚Üí WRONG! Marker check MANDATORY.
"read_lints passed = MCP done" ‚Üí WRONG! read_lints ‚â† MCP validation.

**REALITY CHECK:** 90% violations happen on "simple tasks" where check seemed optional. It's NEVER optional.

**üö® DOCS (read BEFORE modify):**

**Triggers:** FORBIDDEN to modify until docs read.

- ANY `.md/.mdc` ‚Üí `{{RULES_DIR}}/prompt-structure-guide{{FILE_EXT}}`
- `*.test.ts` ‚Üí `{{RULES_DIR}}/testing.md`
- New `.ts/.tsx` ‚Üí `{{RULES_DIR}}/architecture.md`, `{{RULES_DIR}}/naming.md`
- Edit `.ts/.tsx` (‚â•20 lines) ‚Üí `{{RULES_DIR}}/code-standards.md`, `{{RULES_DIR}}/naming.md`
- AI docs ‚Üí `{{RULES_DIR}}/ai-docs-workflow{{FILE_EXT}}`

**AI DOCS TRIGGERS:**

1. New module/package ‚Üí CREATE module-ai-docs.md / package-ai-docs.md
2. Changed public API (signatures, types) ‚Üí UPDATE contract section
3. Added/removed dependency ‚Üí UPDATE dependencies section
4. Fixed behavior bug ‚Üí UPDATE edge_cases section
5. Refactoring without API change ‚Üí DO NOT update

**Exceptions:** README.md, CHANGELOG.md, `*.config.ts`

**Self-check:** Before editing `.md/.mdc` ‚Üí inspect YAML ‚Üí if `type:` exists ‚Üí prompt file ‚Üí trigger applies

**EXTERNAL:**

1. Context7: Before package ‚Üí resolve-library-id + get-library-docs
2. Web Search: Error persists 2+ attempts ‚Üí search ‚Üí retry

**TESTS:**

- Unit: All `.ts/.tsx` need tests in `__tests__/` (except `*.types.ts`, `*.constants.ts`, `*.schema.ts`)
- E2E: New/modified features ‚Üí e2e test in `src/__tests__/e2e/` with mock data

**üö®‚õî VALIDATION ‚Äî BLOCKING (after modifications):**

**REQUIRED:**

- `.ts/.tsx` ‚Üí `code`
- `*.test.ts` ‚Üí `tests`
- `.mdc/.md` ‚Üí `prompts`
- `architecture.xml` ‚Üí `architecture`
- AI docs ‚Üí `documentation`

**SKIP:** README.md, CHANGELOG.md, `*.config.ts`, `package.json`, `tsconfig.json`

**Steps (CRITICAL - PARALLEL EXECUTION):**

1. **PARALLEL:** Batch ALL changed files ‚Üí call MCP validator in PARALLEL (one tool call per file, NOT sequential)
2. Wait for ALL parallel results ‚Üí Target ‚â•85 per file
3. If any file <85 ‚Üí fix ‚Üí re-validate that file (max 3x)
4. ALL files ‚â•85 ‚Üí THEN run `yarn lint` (0 errors REQUIRED)

**WHY PARALLEL:** Sequential validation = N √ó latency. Parallel = 1 √ó latency. Always batch MCP calls.

**ZERO TOLERANCE:** MCP validation is NON-NEGOTIABLE. Never skip, never postpone. 3 failures ‚Üí escalate.

**MCP FEEDBACK HANDLING (ZERO TOLERANCE):**

**Score ‚â•85 = BLOCKING GATE.** "80 is almost 85" = WRONG ‚Üí Fix until ‚â•85.

**Every Issue Must Be Addressed:**

1. Parse ALL issues (critical/warning/suggestion)
2. For EACH ‚Üí FIX or REJECT with documented reason
3. "I fixed something" ‚â† ignore remaining

**Valid Rejection (ONLY):** Contradicts project standards (cite rule) | Technically incorrect | Out of scope for file type

**Invalid Rejection (FORBIDDEN):** "Not critical" ‚Üí FIX | "Pre-existing" ‚Üí FIX | "Close enough" ‚Üí FIX UNTIL ‚â•85

**Pre-existing Policy:** Fix ALL issues in touched files. Leave codebase better.

**Report:** `MCP: [score]/100 | Fixed: [N]/[total] | Rejected: [N] ([reasons])`

**WORKFLOW:**

1. Check plan ‚Üí follow todos
2. Check triggers ‚Üí read docs
3. External deps ‚Üí Context7/web search
4. Execute ‚Üí functional style, unit tests
5. E2E tests ‚Üí new/modified features with mocks
6. ‚õî Validate ALL ‚Üí MCP batch in PARALLEL (‚â•85) ‚Äî MUST COMPLETE BEFORE step 7
7. Final ‚Üí run `yarn lint` (0 errors REQUIRED)
8. AI docs ‚Üí check AI DOCS TRIGGERS 1-4 ‚Üí create/update if matched
9. Report ‚Üí files with scores

**PRE-RESPONSE BARRIER:** Verify ALL before responding:

- [ ] Required docs read (if triggers matched)
- [ ] All files validated via MCP (‚â•85)
- [ ] Unit tests written/updated
- [ ] E2E tests for new features
- [ ] Lint/type/test: 0 errors
- [ ] AI docs created/updated (if AI DOCS TRIGGERS 1-4 matched)

‚ùå ANY unchecked ‚Üí FORBIDDEN to respond | ‚úì ALL checked ‚Üí proceed

**FALLBACKS:** MCP unavailable ‚Üí lint/type/test | Validation <85 ‚Üí iterate 3x | Unclear ‚Üí ask

<completion_criteria>
All validated (‚â•85), e2e tests pass, lint/type/test: 0 errors, todos done.

Format: `[OK] Modified [N] | Validated [N] | ‚â•85: YES | E2E: PASS | Errors: 0 | COMPLETE`
</completion_criteria>

</agent_mode_workflow>
