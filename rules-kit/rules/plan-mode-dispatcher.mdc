---
id: plan-mode-dispatcher
type: compact
alwaysApply: false
description: Plan Mode task classification and workflow routing. Meta-classifier for activity type determination with immediate workflow file reading. Use in Plan Mode for routing to appropriate workflows based on task type.
---

# Plan Mode Dispatcher

<plan_mode_dispatcher>

**üö® CRITICAL - ABSOLUTE ZERO EXCEPTIONS üö®**

**WHY THIS MATTERS:**

- Skipping classification ‚Üí wrong workflow ‚Üí failed plan
- Skipping workflow read ‚Üí missing critical instructions ‚Üí incomplete plan
- Plans without proper research fail 80% of the time

Classification is MANDATORY for EVERY task. "Task is simple" or "faster without protocol" = WRONG REASONING. NO shortcuts, NO bypassing, NO exceptions - EVER.

**ACTIVATION:** Run only when "Plan mode is active" in system_reminder; otherwise skip.

**FIRST ACTION:** Classify activity type before ANY response. Skipping = plan aborts.

**BLOCKING GATE BEFORE create_plan**

PROHIBIT create_plan unless ALL checks pass:

- [ ] Type classified
- [ ] Type announced: "üìã [type] ‚Üí üìÑ {{RULES_DIR}}/[name]{{FILE_EXT}} ‚Üí Following as primary instructions"
- [ ] Workflow file read: read_file('{{RULES_DIR}}/[name]{{FILE_EXT}}') in same batch
- [ ] Content received and **understood**
- [ ] **Workflow instructions followed** (each workflow has its own research/validation requirements)

IF any check fails ‚Üí abort, retry classification (max 3 times), then report error

**üö® ZERO TOLERANCE ENFORCEMENT üö®**

‚ùå VIOLATION: create_plan called without type announcement ‚Üí PROTOCOL FAILURE
‚ùå VIOLATION: create_plan called without reading workflow file ‚Üí PROTOCOL FAILURE
‚ùå VIOLATION: create_plan called without following workflow instructions ‚Üí PROTOCOL FAILURE

‚ö†Ô∏è SELF-CHECK: "Did I read and follow the workflow file instructions?" NO ‚Üí STOP, read workflow NOW

**AFTER PLAN EXECUTION (CRITICAL):**

When user approves plan and execution starts:

1. **MANDATORY FIRST LINE:** Output `[MODE_INITIALIZED: AGENT_MODE] ‚Üí üìÑ {{RULES_DIR}}/07-agent-mode-workflow{{FILE_EXT}} ‚Üí Following as primary instructions (already loaded)`
2. Then execute todos - FORBIDDEN to skip step 1

**Classification Algorithm**

1. READ user request for codes ONLY
2. CHECK codes: `td*` ‚Üí instant match ‚Üí go to step 5
3. IF no code ‚Üí check file extensions ‚Üí match from table
4. IF no match ‚Üí analyze keywords and context ‚Üí select highest density
5. SELECT type ‚Üí IF tie ‚Üí first from Activity Types table
6. ANNOUNCE: `üìã [type] ‚Üí üìÑ {{RULES_DIR}}/[name]{{FILE_EXT}} ‚Üí Following as primary instructions`
7. READ: read_file('{{RULES_DIR}}/[name]{{FILE_EXT}}') in same batch
8. VERIFY: content received ‚Üí IF failed ‚Üí retry up to 3 times; after 3rd failure ‚Üí DEFAULT
9. **FOLLOW:** Execute workflow instructions (research, validation, etc.) BEFORE create_plan
10. PROCEED: create_plan (only after workflow requirements satisfied)

IF no match at step 5 ‚Üí DEFAULT to Code Development

**ANTI-SHORTCUT:** "Task is obvious" = WRONG. "I know this workflow" = WRONG. ALWAYS read file. ALWAYS follow instructions.

**Priority:** Codes > Extensions > Keywords > Context > Default

**Activity Types**

| Activity           | Codes         | Key Triggers                                                                                               | File                                                |
| :----------------- | :------------ | :--------------------------------------------------------------------------------------------------------- | :-------------------------------------------------- |
| Prompt Engineering | `tdprompt`    | `.cursor/`, `.mdc`, "prompt", "rules", "workflow"                                                          | `{{RULES_DIR}}/prompt-workflow{{FILE_EXT}}`         |
| Code Development   | `tdcode`      | `.ts`, `.tsx`, `.js`, "bug", "fix", "implement", "refactor"                                                | `{{RULES_DIR}}/code-workflow{{FILE_EXT}}`           |
| UI Development     | `tdui`        | "ui", "interface", "visual", "component", "layout"                                                         | `{{RULES_DIR}}/ui-workflow{{FILE_EXT}}`             |
| AI Documentation   | `tdaidoc`     | "ai-docs", "package-ai-docs", "module-ai-docs"                                                             | `{{RULES_DIR}}/ai-docs-workflow{{FILE_EXT}}`        |
| Technical Critique | `tdcritic`    | "critique", "review", "evaluate", "code review"                                                            | `{{RULES_DIR}}/critique-workflow{{FILE_EXT}}`       |
| JIRA Task          | `tdjira`      | "JIRA task", "technical spec", "create task"                                                               | `{{RULES_DIR}}/jira-task-creator{{FILE_EXT}}`       |
| Auxiliary Dev      | `tdaux`       | "script", "deploy", "automation", "CI/CD"                                                                  | `{{RULES_DIR}}/auxiliary-code-workflow{{FILE_EXT}}` |
| Bootstrap App      | `tdbootstrap` | "bootstrap", "create app", "new application", "from scratch", "setup infrastructure", "initialize project" | `{{RULES_DIR}}/bootstrap-app-workflow{{FILE_EXT}}`  |

**PRE-CREATE_PLAN BARRIER:**

BEFORE calling create_plan, verify ALL:

- [ ] Type classified and announced
- [ ] Workflow file read
- [ ] **Workflow instructions followed** (research done, validation passed)
- [ ] Plan content complete per workflow template

‚ùå ANY unchecked ‚Üí FORBIDDEN to call create_plan

**FORBIDDEN:**

- create_plan before classification
- create_plan before reading workflow
- create_plan before following workflow instructions
- Skipping research/validation steps defined in workflow

**Example:** `üìã Code Development ‚Üí üìÑ {{RULES_DIR}}/code-workflow{{FILE_EXT}} ‚Üí Following as primary instructions`

</plan_mode_dispatcher>
