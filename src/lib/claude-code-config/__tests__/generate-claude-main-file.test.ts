import { describe, expect, it } from 'vitest';

import { generateClaudeMainFile, generateClaudeRulesBlock } from '../generate-claude-main-file';

describe('generateClaudeMainFile', () => {
    it('должен генерировать CLAUDE.md с заголовком', () => {
        const rules = [
            { content: '# Rule 1\nContent 1', id: 'rule1' },
            { content: '# Rule 2\nContent 2', id: 'rule2' },
        ];
        const docsCatalog = '# Docs Catalog';

        const result = generateClaudeMainFile(rules, docsCatalog);

        expect(result).toContain('AUTO-GENERATED by ai-rules-kit');
        expect(result).toContain('# Project AI Rules');
        expect(result).toContain('<!-- Rule: rule1 -->');
        expect(result).toContain('<!-- Rule: rule2 -->');
        expect(result).toContain('# Docs Catalog');
    });

    it('должен убирать YAML frontmatter из правил', () => {
        const rules = [{ content: '---\nid: rule1\n---\n# Rule 1', id: 'rule1' }];
        const docsCatalog = '';

        const result = generateClaudeMainFile(rules, docsCatalog);

        expect(result).not.toContain('id: rule1');
        expect(result).toContain('# Rule 1');
    });
});

describe('generateClaudeRulesBlock', () => {
    it('должен генерировать блок с тегами', () => {
        const rules = [
            { content: '# Rule 1\nContent 1', id: 'rule1' },
            { content: '# Rule 2\nContent 2', id: 'rule2' },
        ];
        const docsCatalog = '# Docs Catalog';

        const result = generateClaudeRulesBlock(rules, docsCatalog);

        expect(result).toContain('<!-- CLAUDE-RULES-START -->');
        expect(result).toContain('<!-- CLAUDE-RULES-END -->');
        expect(result).toContain('AUTO-GENERATED by ai-rules-kit');
        expect(result).toContain('## Project AI Rules');
        expect(result).toContain('<!-- Rule: rule1 -->');
        expect(result).toContain('<!-- Rule: rule2 -->');
        expect(result).toContain('# Docs Catalog');
    });

    it('должен убирать YAML frontmatter из правил', () => {
        const rules = [{ content: '---\nid: rule1\n---\n# Rule 1', id: 'rule1' }];
        const docsCatalog = '';

        const result = generateClaudeRulesBlock(rules, docsCatalog);

        expect(result).not.toContain('id: rule1');
        expect(result).toContain('# Rule 1');
    });

    it('должен начинаться с открывающего тега', () => {
        const rules = [{ content: '# Rule 1', id: 'rule1' }];
        const docsCatalog = '';

        const result = generateClaudeRulesBlock(rules, docsCatalog);

        expect(result.trimStart().startsWith('<!-- CLAUDE-RULES-START -->')).toBe(true);
    });

    it('должен заканчиваться закрывающим тегом', () => {
        const rules = [{ content: '# Rule 1', id: 'rule1' }];
        const docsCatalog = '';

        const result = generateClaudeRulesBlock(rules, docsCatalog);

        expect(result.trimEnd().endsWith('<!-- CLAUDE-RULES-END -->')).toBe(true);
    });
});
