import matter from 'gray-matter';

import { CLAUDE_MAIN_FILE_NAME } from '../../model';

/** Правило для включения в CLAUDE.md */
type AlwaysApplyRule = {
    content: string;
    id: string;
};

/**
 * Генерирует содержимое файла CLAUDE.md
 * @param rules - Массив правил с alwaysApply: true
 * @param docsCatalogContent - Содержимое docs-catalog.md
 * @returns Содержимое файла CLAUDE.md
 */
export function generateClaudeMainFile(rules: AlwaysApplyRule[], docsCatalogContent: string): string {
    const parts: string[] = [];

    // Заголовок с предупреждением об авто-генерации
    parts.push(`<!--`);
    parts.push(`AUTO-GENERATED by ai-rules-kit`);
    parts.push(`DO NOT EDIT THIS FILE MANUALLY`);
    parts.push(`Source: https://github.com/CyberWalrus/ai-rules-kit`);
    parts.push('-->');
    parts.push('');
    parts.push(`# Project AI Rules`);
    parts.push('');
    parts.push('This file contains the core AI rules for this project.');
    parts.push('');

    // Добавляем каждое правило без YAML frontmatter
    for (const rule of rules) {
        const parsed = matter(rule.content);
        const content = String(parsed.content).trim();

        parts.push(`<!-- Rule: ${rule.id} -->`);
        parts.push('');
        parts.push(content);
        parts.push('');
        parts.push('---');
        parts.push('');
    }

    // Добавляем docs-catalog в конец
    parts.push('<!-- Docs Catalog -->');
    parts.push('');
    parts.push(docsCatalogContent);

    return parts.join('\n');
}

/**
 * Возвращает имя файла CLAUDE.md
 * @returns Имя файла
 */
export function getClaudeMainFileName(): string {
    return CLAUDE_MAIN_FILE_NAME;
}
