# Техническое задание: Переписывание cursor-rules-cli на Go

## 1. Общее описание

### 1.1. Назначение

CLI-инструмент для управления правилами Cursor IDE в проектах. Инструмент позволяет инициализировать, обновлять и полностью заменять наборы правил (prompts) из GitHub репозитория в локальных проектах.

### 1.2. Основные функции

- Инициализация правил в проекте (команда `init`)
- Полная замена правил на последнюю версию (команда `replace-all`)
- Инкрементальное обновление правил с сохранением пользовательских изменений (команда `upgrade`)
- Автоматическая проверка обновлений CLI-инструмента
- Управление конфигурацией через JSON-файл

### 1.3. Целевая аудитория

Разработчики, использующие Cursor IDE и желающие автоматизировать управление правилами AI-промптов в своих проектах.

---

## 2. Архитектура и структура

### 2.1. Команды CLI

Инструмент должен поддерживать три основные команды:

#### 2.1.1. Команда `init`

**Назначение:** Первичная инициализация правил в проекте.

**Поведение:**

1. Проверяет, что правила еще не инициализированы (отсутствует файл `.cursor/cursor-rules-config.json`)
2. Если правила уже инициализированы — выдает ошибку с указанием текущей версии
3. Получает последнюю версию промптов из GitHub репозитория `CyberWalrus/cursor-rules`
4. Скачивает tarball с правилами по URL: `https://github.com/CyberWalrus/cursor-rules/archive/refs/tags/prompts/v{VERSION}.tar.gz`
5. Распаковывает tarball во временную директорию
6. Копирует содержимое директорий `.cursor/rules`, `.cursor/docs`, `.cursor/commands` из распакованного архива в целевую директорию проекта
7. Создает файл конфигурации `.cursor/cursor-rules-config.json` с начальными настройками
8. Удаляет временную директорию
9. Выводит сообщение об успешной инициализации с указанием версии

**Параметры:**

- Целевая директория: текущая рабочая директория (CWD)
- Директория пакета: определяется автоматически на основе расположения исполняемого файла

**Обработка ошибок:**

- Отсутствие интернет-соединения → ошибка с понятным сообщением
- Ошибка GitHub API (403, 404 и т.д.) → ошибка с рекомендацией установить `GITHUB_TOKEN`
- Ошибка записи файлов → ошибка с указанием проблемы

#### 2.1.2. Команда `replace-all`

**Назначение:** Полная замена всех правил на последнюю версию без сохранения пользовательских изменений.

**Поведение:**

1. Читает существующую конфигурацию из `.cursor/cursor-rules-config.json` (если существует)
2. Получает последнюю версию промптов из GitHub
3. Если нет интернета и есть существующая конфигурация:
   - Предупреждает пользователя
   - Запрашивает подтверждение использовать текущую локальную версию
   - При отказе — прерывает выполнение
4. Если нет интернета и нет конфигурации — выдает ошибку
5. Скачивает и распаковывает tarball с последней версией
6. **Полностью удаляет** директории `.cursor/rules`, `.cursor/docs`, `.cursor/commands` из целевого проекта
7. Копирует новые файлы из архива в целевой проект
8. Применяет переопределения YAML frontmatter из конфигурации (если указаны в `fileOverrides`)
9. Обновляет конфигурацию: обновляет `promptsVersion`, `cliVersion`, `updatedAt`
10. Сохраняет существующие настройки: `ruleSets`, `ignoreList`, `fileOverrides`, `settings`
11. Удаляет временную директорию
12. Выводит сообщение об успешной замене с указанием версии

**Параметры:** Аналогично команде `init`

**Обработка ошибок:**

- Отсутствие конфигурации — не критично (создается новая)
- Ошибки сети — аналогично команде `init`

#### 2.1.3. Команда `upgrade`

**Назначение:** Инкрементальное обновление правил с сохранением пользовательских изменений и применением переопределений.

**Поведение:**

1. Проверяет наличие конфигурации — если отсутствует, выдает ошибку с рекомендацией выполнить `init`
2. Читает текущую версию из конфигурации (`promptsVersion` или устаревшее поле `version`)
3. Определяет наборы правил для обновления (только те, у которых `ruleSets[].update === true`)
4. Если нет наборов для обновления — завершает выполнение без действий
5. Проверяет наличие неизвестных наборов правил (не из списка известных: `["base"]`) — выдает предупреждение, но продолжает
6. Получает последнюю версию из GitHub
7. Если нет интернета:
   - Предупреждает пользователя
   - Запрашивает подтверждение использовать текущую версию
   - При отказе — прерывает выполнение
8. Сравнивает версии:
   - Если версии совпадают — выводит сообщение "Prompts are up to date" и завершает
   - Если локальная версия новее GitHub версии — предупреждает и запрашивает подтверждение на даунгрейд
9. Скачивает и распаковывает tarball с последней версией
10. **Вычисляет diff** между новой версией и текущей:
    - Сканирует директории `.cursor/rules`, `.cursor/docs`, `.cursor/commands` в обеих версиях
    - Вычисляет SHA-256 хеш для каждого файла
    - Определяет файлы для добавления (`toAdd`), обновления (`toUpdate`), удаления (`toDelete`)
11. Копирует файлы из новой версии в целевую директорию:
    - Применяет список игнорирования (`ignoreList`) — файлы, соответствующие glob-паттернам, не копируются
    - Применяет переопределения YAML frontmatter (`fileOverrides`) для указанных файлов
12. Обновляет конфигурацию: `promptsVersion`, `cliVersion`, `updatedAt`
13. Удаляет временную директорию
14. Выводит сообщение об успешном обновлении с указанием версий (от → до)

**Параметры:** Аналогично команде `init`

**Обработка ошибок:**

- Отсутствие конфигурации → ошибка с рекомендацией выполнить `init`
- Ошибки сети → аналогично другим командам

### 2.2. Вспомогательные функции

#### 2.2.1. Работа с GitHub API

**Функция получения последней версии:**

- URL: `https://api.github.com/repos/CyberWalrus/cursor-rules/tags?per_page=100`
- Поддержка аутентификации через переменную окружения `GITHUB_TOKEN` (Bearer token)
- Headers: `User-Agent: cursor-rules-cli`, опционально `Authorization: Bearer {token}`
- Фильтрация тегов: только теги, начинающиеся с `prompts/v`
- Сортировка: по убыванию версии (CalVer формат: `YYYY.M.D.N`)
- Возвращает версию без префикса `prompts/v`

**Обработка ошибок:**

- Сетевые ошибки → возвращает `null` и выводит предупреждение
- HTTP 403 → предупреждение о необходимости установить `GITHUB_TOKEN` (без токена: 60 req/hour, с токеном: 5000 req/hour)
- HTTP 404/500 → предупреждение с кодом статуса
- Ошибки парсинга JSON → предупреждение

**Функция скачивания tarball:**

- URL: `https://github.com/CyberWalrus/cursor-rules/archive/refs/tags/prompts/v{VERSION}.tar.gz`
- Скачивание через HTTP GET
- Распаковка tar.gz архива во временную директорию
- Удаление корневой директории архива (strip: 1)
- Обработка ошибок: HTTP статусы, ошибки распаковки

#### 2.2.2. Работа с файловой системой

**Копирование правил:**

- Рекурсивное копирование директорий: `.cursor/rules`, `.cursor/docs`, `.cursor/commands`
- Сохранение структуры директорий
- Применение списка игнорирования (glob-паттерны, относительно `.cursor/`)
- Создание директорий при необходимости
- Перезапись существующих файлов

**Удаление правил:**

- Рекурсивное удаление директорий: `.cursor/rules`, `.cursor/docs`, `.cursor/commands`
- Игнорирование отсутствующих директорий (не ошибка)

**Сканирование директории:**

- Рекурсивный обход директории
- Вычисление SHA-256 хеша для каждого файла
- Возврат карты: относительный путь → хеш
- Нормализация путей: замена обратных слешей на прямые (`\` → `/`)
- Обработка отсутствующих директорий (возврат пустой карты)

**Вычисление diff:**

- Сравнение двух директорий (источник и цель)
- Определение файлов для добавления (есть в источнике, нет в цели)
- Определение файлов для обновления (есть в обоих, но хеши различаются)
- Определение файлов для удаления (есть в цели, нет в источнике)
- Возврат структуры: `{ toAdd: [], toUpdate: [], toDelete: [] }`

#### 2.2.3. Работа с конфигурацией

**Структура конфигурации:**

```json
{
  "$schema": "https://raw.githubusercontent.com/CyberWalrus/cursor-rules-cli/main/.cursor/cursor-rules-config-{configVersion}.schema.json",
  "cliVersion": "0.4.1",
  "configVersion": "1.0.0",
  "installedAt": "2025-11-07T10:00:00.000Z",
  "updatedAt": "2025-11-07T12:30:00.000Z",
  "source": "cursor-rules",
  "promptsVersion": "2025.11.7.1",
  "settings": {
    "language": "ru"
  },
  "ruleSets": [
    {
      "id": "base",
      "update": true,
      "fixedVersion": "2025.11.7.1"
    }
  ],
  "ignoreList": [
    "rules/custom-project-rule.mdc",
    "rules/**/*.custom.mdc"
  ],
  "fileOverrides": [
    {
      "file": "rules/code-standards.mdc",
      "yamlOverrides": {
        "alwaysApply": true,
        "priority": 10
      }
    }
  ]
}
```

**Валидация конфигурации:**

- `configVersion`: semver формат (`^\d+\.\d+\.\d+$`)
- `cliVersion`: semver формат
- `promptsVersion`: CalVer формат (`^\d{4}\.\d{1,2}\.\d{1,2}\.\d+$`)
- `installedAt`, `updatedAt`: ISO 8601 datetime
- `settings.language`: enum `["ru", "en"]`
- `ruleSets`: массив объектов с полями `id` (непустая строка), `update` (boolean), `fixedVersion` (опционально, semver)
- `ignoreList`: массив строк (glob-паттерны)
- `fileOverrides`: массив объектов с полями `file` (непустая строка), `yamlOverrides` (объект)

**Чтение конфигурации:**

- Путь: `.cursor/cursor-rules-config.json` относительно целевой директории
- Парсинг JSON
- Валидация через схему
- Возврат `null` если файл отсутствует или невалиден

**Запись конфигурации:**

- Создание директории `.cursor` при необходимости
- Добавление поля `$schema` с URL схемы
- Форматирование JSON с отступами (2 пробела)
- Запись в файл `.cursor/cursor-rules-config.json`

#### 2.2.4. Работа с YAML frontmatter

**Применение переопределений:**

- Чтение файла (обычно `.mdc` или `.md`)
- Парсинг YAML frontmatter (формат: `---\nkey: value\n---\ncontent`)
- Слияние существующих данных с переопределениями (приоритет у переопределений)
- Перезапись файла с обновленным frontmatter

**Формат файла:**

```
---
key1: value1
key2: value2
---
Основной контент файла
```

#### 2.2.5. Работа с версиями

**Сравнение semver версий:**

- Формат: `MAJOR.MINOR.PATCH` (например, `0.4.1`)
- Возврат типа изменения: `major`, `minor`, `patch`, `none`
- Логика: сравнение по порядку (major → minor → patch)

**Сравнение CalVer версий:**

- Формат: `YYYY.M.D.N` (например, `2025.11.7.1`)
- Возврат типа изменения: `major`, `minor`, `patch`, `none`
- Логика:
    - Изменение года или месяца → `major`
    - Изменение дня → `minor`
    - Изменение инкремента → `patch`
    - Обратное сравнение (локальная новее) → `none`

**Получение версии пакета:**

- Чтение `package.json` из директории пакета
- Извлечение поля `version`
- Обработка ошибок: отсутствие файла, невалидный JSON

**Получение текущей версии правил:**

- Чтение конфигурации
- Извлечение `promptsVersion` или устаревшего `version`
- Возврат `null` если конфигурация отсутствует

#### 2.2.6. Интерактивность

**Запрос подтверждения:**

- Вывод вопроса в формате: `{question} (y/n):`
- Чтение ответа из stdin
- Нормализация: trim, toLowerCase
- Возврат `true` если ответ `"y"` или `"yes"`, иначе `false`
- Обработка прерывания (Ctrl+C)

#### 2.2.7. Проверка обновлений CLI

**Проверка обновлений:**

- Получение текущей версии из исполняемого файла (встроенная версия при сборке)
- Запрос к npm registry: `https://registry.npmjs.org/cursor-rules-cli/latest`
- Timeout: 5 секунд
- Сравнение версий (semver)
- Если есть обновление — вывод уведомления в простом и универсальном формате (используется в большинстве CLI инструментов):

```
A new version of cursor-rules-cli is available: 0.4.0 → 0.4.1

To update, run:
  npm i -g cursor-rules-cli@latest

Or if installed via Homebrew:
  brew upgrade cursor-rules-cli

Or visit: https://github.com/CyberWalrus/cursor-rules-cli/releases/latest
```

**Особенности:**

- Простой текстовый формат без рамок (универсальная совместимость)
- Цветное оформление (опционально): желтый/cyan для заголовка, красный для текущей версии, зеленый для новой версии
- Автоматическое определение поддержки цветов в терминале (через `NO_COLOR` env или проверку `TERM`)
- Fallback на обычный текст если цвета не поддерживаются
- Команды обновления для обоих способов распространения (npm и brew tap)
- Минимальная ширина вывода (не ломается на узких терминалах)

- Выполнение в фоновом режиме (не блокирует выполнение команд)
- Игнорирование ошибок (не должно прерывать работу команды)

---

## 3. Константы и настройки

### 3.1. Константы

- **GitHub репозиторий:** `CyberWalrus/cursor-rules`
- **Директории правил:** `[".cursor/rules", ".cursor/docs", ".cursor/commands"]`
- **Имя файла конфигурации:** `cursor-rules-config.json`
- **Путь к конфигурации:** `.cursor/cursor-rules-config.json`
- **Имя пакета npm:** `cursor-rules-cli`
- **URL npm registry:** `https://registry.npmjs.org`
- **Timeout для npm запросов:** 5000 мс
- **User-Agent для HTTP запросов:** `cursor-rules-cli`

### 3.2. Переменные окружения

- `GITHUB_TOKEN` (опционально) — токен для GitHub API (Bearer token)
- `NODE_ENV` (опционально) — режим окружения (`development` для отладочных сообщений)

---

## 4. Обработка ошибок

### 4.1. Типы ошибок

**Критические ошибки (прерывают выполнение):**

- Отсутствие обязательных параметров
- Ошибки валидации конфигурации
- Ошибки записи файлов
- Ошибки при отсутствии интернета в команде `init` (когда нет локальной конфигурации)

**Некритические ошибки (предупреждения):**

- Ошибки сети при проверке обновлений CLI
- Ошибки GitHub API (403, 404) — выводятся предупреждения
- Отсутствие директорий при удалении (игнорируется)

### 4.2. Сообщения об ошибках

**Формат:**

- Критические: `Error: {описание проблемы}`
- Предупреждения: `⚠️ {описание проблемы}`
- Успех: `✓ {сообщение}`

**Примеры:**

- `Error: Rules already initialized with version 2025.11.7.1`
- `Error: Failed to fetch latest prompts version from GitHub. No internet connection or GitHub API unavailable.`
- `⚠️ GitHub API error: 403 Forbidden. Set GITHUB_TOKEN environment variable to increase rate limit.`
- `✓ Initialized prompts version 2025.11.7.1`

---

## 5. Требования к реализации

### 5.1. Язык программирования

- Go 1.21 или выше

### 5.2. Зависимости (рекомендуемые библиотеки)

- HTTP клиент: стандартная библиотека `net/http` или `github.com/go-resty/resty`
- Работа с tar.gz: стандартная библиотека `archive/tar`, `compress/gzip`
- Парсинг YAML: `gopkg.in/yaml.v3` или `github.com/go-yaml/yaml`
- JSON: стандартная библиотека `encoding/json`
- Glob паттерны: `github.com/gobwas/glob` или встроенная реализация
- Цветной вывод: `github.com/fatih/color` или `github.com/gookit/color`
- CLI фреймворк: `github.com/spf13/cobra` или `github.com/urfave/cli/v2`
- Хеширование: стандартная библиотека `crypto/sha256`

### 5.3. Структура проекта (рекомендация)

```
cmd/
  cursor-rules-cli/
    main.go
internal/
  commands/
    init.go
    replace_all.go
    upgrade.go
  config/
    config.go
    schema.go
  fileops/
    copy.go
    delete.go
    scan.go
    diff.go
    yaml.go
  github/
    api.go
    tarball.go
  version/
    compare.go
    semver.go
    calver.go
    package.go
  ui/
    confirmation.go
    update_notification.go
pkg/
  (публичные API, если нужны)
```

### 5.4. Тестирование

- Unit тесты для всех функций (покрытие ≥80%)
- Интеграционные тесты для команд (с моками GitHub API)
- E2E тесты для полного цикла работы

### 5.5. Сборка и распространение

- Поддержка сборки для платформ: Linux (amd64, arm64), macOS (amd64, arm64), Windows (amd64, arm64)
- Статическая линковка (по возможности)
- Версионирование через git tags
- Автоматическая сборка через CI/CD
- **Распространение:**
    - **npm**: публикация в npm registry как `cursor-rules-cli` (установка: `npm i -g cursor-rules-cli`)
    - **Homebrew tap**: создание tap репозитория для установки через `brew install` (установка: `brew install user/tap/cursor-rules-cli`)
    - Оба способа должны автоматически определять способ установки для показа правильных команд обновления

---

## 6. Особенности реализации

### 6.1. Определение директории пакета

- Если исполняемый файл находится в `dist/` или `bin/` — родительская директория
- Иначе — три уровня вверх от расположения исполняемого файла
- Нормализация путей: замена обратных слешей на прямые

### 6.2. Временные директории

- Использование системной временной директории
- Имя: `cursor-rules-{timestamp}`
- Обязательная очистка после использования (даже при ошибках)

### 6.3. Параллельное выполнение

- Параллельное копирование директорий правил (где возможно)
- Параллельное применение переопределений YAML

### 6.4. Обработка прерываний

- Корректная обработка SIGINT (Ctrl+C)
- Очистка временных файлов при прерывании

### 6.5. Определение способа установки

Для корректного отображения команд обновления необходимо определять способ установки:

- **npm**: проверка пути исполняемого файла — если находится в директории, содержащей `node_modules` или `npm`, или в стандартных npm-директориях (`/usr/local/lib/node_modules`, `~/.npm-global`)
- **Homebrew**: проверка пути исполняемого файла — если находится в директории `/opt/homebrew/bin`, `/usr/local/bin` (для Intel Mac) или других стандартных Homebrew-директориях
- **Fallback**: если способ установки не определен — показывать оба варианта команд обновления

---

## 7. Примеры использования

### 7.1. Установка

**Через npm:**

```bash
npm i -g cursor-rules-cli
```

**Через Homebrew:**

```bash
brew install user/tap/cursor-rules-cli
```

### 7.2. Инициализация

```bash
cursor-rules-cli init
# → Скачивает последнюю версию, копирует файлы, создает конфигурацию
# → Вывод: ✓ Initialized prompts version 2025.11.7.1
```

### 7.3. Полная замена

```bash
cursor-rules-cli replace-all
# → Удаляет старые правила, скачивает новые, применяет переопределения
# → Вывод: ✓ Replaced prompts to version 2025.11.7.2
```

### 7.4. Обновление

```bash
cursor-rules-cli upgrade
# → Вычисляет diff, обновляет только измененные файлы
# → Вывод: ✓ Upgraded from 2025.11.7.1 to 2025.11.7.2
```

### 7.5. С токеном GitHub

```bash
GITHUB_TOKEN=ghp_xxx cursor-rules-cli upgrade
```

---

## 8. Миграция с TypeScript версии

### 8.1. Совместимость

- Полная совместимость формата конфигурации
- Совместимость с существующими файлами правил
- Одинаковое поведение команд

### 8.2. Отличия

- Нативный исполняемый файл вместо `node dist/cli.cjs`
- Отсутствие зависимости от Node.js (для работы инструмента)
- Более быстрая работа (нативная компиляция)
- Распространение через npm и Homebrew tap (как и TypeScript версия)
- Автоматическое определение способа установки для корректных команд обновления

---

## 9. Дополнительные требования

### 9.1. Производительность

- Быстрая работа с большими наборами правил (100+ файлов)
- Минимальное использование памяти
- Эффективная работа с сетью (таймауты, retry при необходимости)

### 9.2. Надежность

- Обработка всех возможных ошибок
- Валидация входных данных
- Защита от race conditions при параллельном выполнении

### 9.3. Удобство использования

- Понятные сообщения об ошибках
- Цветной вывод (опционально, с проверкой поддержки терминала)
- Поддержка `--help` для всех команд
- Версионирование через `--version`

---

## 10. Критерии приемки

✅ Все три команды (`init`, `replace-all`, `upgrade`) работают корректно  
✅ Поддержка GitHub API с токеном и без  
✅ Корректная работа с конфигурацией (чтение, запись, валидация)  
✅ Применение списка игнорирования и переопределений YAML  
✅ Вычисление diff при обновлении  
✅ Проверка обновлений CLI (не блокирует выполнение)  
✅ Обработка всех типов ошибок  
✅ Тесты покрывают основные сценарии  
✅ Сборка для всех целевых платформ  
✅ Документация по использованию  

---

**Дата создания:** 2025-11-07  
**Версия документа:** 1.0
